<div class="container mt-4">
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Lab Report Details</h5>
      <span class="badge <%= case @pdf.status
        when 'completed' then 'bg-success'
        when 'failed' then 'bg-danger'
        when 'processing' then 'bg-warning'
        else 'bg-secondary'
        end %>">
        <%= @pdf.status&.humanize %>
      </span>
    </div>
    <div class="card-body">
      <p class="card-text">
        <strong>Uploaded:</strong> <%= @pdf.created_at.in_time_zone.strftime("%B %d, %Y %I:%M %p %Z") %><br>
        <strong>Format:</strong> <%= @pdf.format_name %>
      </p>

      <%= form_with(model: @pdf, local: true, class: "mt-3") do |f| %>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <%= f.text_area :notes, class: "form-control", rows: 3 %>
        </div>
        <%= f.submit "Update Notes", class: "btn btn-primary mt-2" %>
      <% end %>
    </div>
  </div>

  <% if @pdf.status == 'completed' && @parsed_data.present? %>
    <% @parsed_data.each do |category, tests| %>
      <% next if tests.empty? %>
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><%= category %></h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-bordered mb-0">
              <thead class="table-light">
                <tr>
                  <th class="px-3 py-2">Test</th>
                  <th class="px-3 py-2">Method</th>
                  <th class="px-3 py-2">Result</th>
                  <th class="px-3 py-2">Unit</th>
                  <th class="px-3 py-2">Reference Range</th>
                </tr>
              </thead>
              <tbody>
                <% tests.each do |test| %>
                  <tr>
                    <td class="px-3 py-2"><%= test['name'] || test[:name] %></td>
                    <td class="px-3 py-2"><%= test['method'] || test[:method] || '-' %></td>
                    <td class="px-3 py-2">
                      <span class="<%= (test['flag'] || test[:flag]).present? ? 'text-danger' : '' %>">
                        <%= test['value'] || test[:value] || '-' %>
                      </span>
                    </td>
                    <td class="px-3 py-2"><%= test['unit'] || test[:unit] || '-' %></td>
                    <td class="px-3 py-2">
                      <% if test['biological_ref_interval'] || test[:biological_ref_interval] %>
                        <%= test['biological_ref_interval'] || test[:biological_ref_interval] %>
                      <% else %>
                        -
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    <% end %>
  <% elsif @pdf.status == 'processing' %>
    <div class="alert alert-warning">
      <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        Your PDF is currently being processed...
      </div>
    </div>
  <% elsif @pdf.status == 'failed' %>
    <div class="alert alert-danger">
      There was an error processing your PDF. Please try uploading it again.
    </div>
  <% else %>
    <div class="alert alert-info">
      Processing will begin shortly...
    </div>
  <% end %>

  <div class="mt-4">
    <%= link_to 'Back to Lab Reports', pdfs_path, class: 'btn btn-secondary' %>
  </div>
</div>

<% if @pdf.status == 'completed' && @parsed_data.present? %>
  <script>
    // Add console logging for debugging
    console.group('Lab Test Processing Results');
    <% @parsed_data.each do |category, tests| %>
      console.group('<%= category %>');
      <% tests.each do |test| %>
        console.log('Test:', <%= raw test.to_json %>);
      <% end %>
      console.groupEnd();
    <% end %>
    console.groupEnd();
  </script>
<% end %>

<% if Rails.env.development? %>
  <div class="card mt-4">
    <div class="card-header">
      <h5 class="mb-0">Debug Information</h5>
    </div>
    <div class="card-body">
      <p><strong>Status:</strong> <%= @pdf.status %></p>
      <p><strong>Scan Method:</strong> <%= @pdf.scan_method %></p>
      <p><strong>Raw Data:</strong></p>
      <pre><%= JSON.pretty_generate(@parsed_data) rescue @parsed_data.inspect %></pre>
    </div>
  </div>
<% end %>
